:original_name: waf_01_0009.html

.. _waf_01_0009:

Configuring CC Attack Protection Rules to Defend Against CC Attacks
===================================================================

CC attack protection can limit the access to a protected website based on a single IP address, cookie, or referer. To use this protection, ensure that you have toggled on **CC Attack Protection**.

A reference table can be added to a CC attack protection rule. The reference table takes effect for all protected domain names.

Prerequisites
-------------

You have added the website you want to protect to WAF.

Constraints
-----------

-  If you set **Logic** to **Include any value**, **Exclude any value**, **Equal to any value**, **Not equal to any value**, **Prefix is any value**, **Prefix is not any of them**, **Suffix is any value**, or **Suffix is not any of them**, select an existing reference table. For details, see :ref:`Creating a Reference Table to Configure Protection Metrics in Batches <waf_01_0081>`.
-  It takes several minutes for a new rule to take effect. After a rule takes effect, protection events triggered by the rule will be displayed on the **Events** page.

Configuring a CC Attack Protection Rule
---------------------------------------

#. Log in to the management console.

#. Click |image1| in the upper left corner of the management console and select a region or project.

#. Click |image2| in the upper left corner and choose **Web Application Firewall (Dedicated)** under **Security**.

#. In the navigation pane on the left, click **Policies**.

#. Click the name of the target policy to go to the protection configuration page.

#. Click the **CC Attack Protection** configuration area and toggle it on or off if needed.

   -  |image3|: enabled.
   -  |image4|: disabled.

#. In the upper left corner above the **CC Attack Protection** rule list, click **Add Rule**.

#. In the displayed dialog box, configure a CC attack protection rule by referring to :ref:`Table 1 <waf_01_0009__table480817611214>`.

   .. _waf_01_0009__fig1083929152617:

   .. figure:: /_static/images/en-us_image_0000001683774038.png
      :alt: **Figure 1** Adding a CC attack protection rule

      **Figure 1** Adding a CC attack protection rule

   .. _waf_01_0009__table480817611214:

   .. table:: **Table 1** Rule parameters

      +-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+
      | Parameter             | Description                                                                                                                                                                                                                                                                                                                                                                                         | Example Value                                                                               |
      +=======================+=====================================================================================================================================================================================================================================================================================================================================================================================================+=============================================================================================+
      | Rule Description      | A brief description of the rule. This parameter is optional.                                                                                                                                                                                                                                                                                                                                        | --                                                                                          |
      +-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+
      | Rate Limit Mode       | -  **Per IP address**: A website visitor is identified by the IP address.                                                                                                                                                                                                                                                                                                                           | --                                                                                          |
      |                       | -  **Per user**: A website visitor is identified by the key value of **Cookie** or **Header**.                                                                                                                                                                                                                                                                                                      |                                                                                             |
      |                       | -  **Other**: A website visitor is identified by the Referer field (user-defined request source).                                                                                                                                                                                                                                                                                                   |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       | .. note::                                                                                                                                                                                                                                                                                                                                                                                           |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       |    If you set **Rate Limit Mode** to **Other**, set **Content** of **Referer** to a complete URL containing the domain name. The **Content** field supports prefix match and exact match only, but cannot contain two or more consecutive slashes, for example, **///admin**. If you enter **///admin**, WAF will convert it to **/admin**.                                                         |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       |    For example, if you do not want visitors to access www.test.com, set **Referer** to **http://www.test.com**.                                                                                                                                                                                                                                                                                     |                                                                                             |
      +-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+
      | User Identifier       | This parameter is mandatory when you select **Per user** for **Rate Limit Mode**.                                                                                                                                                                                                                                                                                                                   | name                                                                                        |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       | -  **Cookie**: A cookie field name. You need to configure an attribute variable name in the cookie that can uniquely identify a web visitor based on your website requirements. This field does not support regular expressions. Only complete matches are supported.                                                                                                                               |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       |    For example, if a website uses the **name** field in the cookie to uniquely identify a web visitor, enter **name**.                                                                                                                                                                                                                                                                              |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       | -  **Header**: Set the user-defined HTTP header you want to protect. You need to configure the HTTP header that can identify web visitors based on your website requirements.                                                                                                                                                                                                                       |                                                                                             |
      +-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+
      | Trigger               | Click **Add** and add conditions. At least one condition is required, but up to 30 conditions are allowed. If you add more than one condition, the rule will only take effect when all conditions are met.                                                                                                                                                                                          | **Path** **Include** **/admin**                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       | -  **Field**                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       | -  **Subfield**: Configure this field only when **IPv4**, **Cookie**, **Header**, or **Params** is selected for **Field**.                                                                                                                                                                                                                                                                          |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       |    .. important::                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       |       NOTICE:                                                                                                                                                                                                                                                                                                                                                                                       |                                                                                             |
      |                       |       A subfield cannot exceed 2,048 characters.                                                                                                                                                                                                                                                                                                                                                    |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       | -  **Logic**: Select a logical relationship from the drop-down list.                                                                                                                                                                                                                                                                                                                                |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       |    .. note::                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       |       If you set **Logic** to **Include any value**, **Exclude any value**, **Equal to any value**, **Not equal to any value**, **Prefix is any value**, **Prefix is not any of them**, **Suffix is any value**, or **Suffix is not any of them**, select an existing reference table. For details, see :ref:`Creating a Reference Table to Configure Protection Metrics in Batches <waf_01_0081>`. |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       | -  **Content**: Enter or select the content that matches the condition.                                                                                                                                                                                                                                                                                                                             |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       |    If you enable this, the system matches the case-sensitive content. It helps the system precisely identify requests and respond to them accurately, making protection policies work better.                                                                                                                                                                                                       |                                                                                             |
      +-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+
      | Rate Limit            | The number of requests allowed from a website visitor in the rate limit period. If the number of requests exceeds the rate limit, WAF takes the action you configure for **Protective Action**.                                                                                                                                                                                                     | **10** requests allowed in **60** seconds                                                   |
      +-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+
      | Protective Action     | The action that WAF will take if the number of requests exceeds **Rate Limit** you configured. The options are as follows:                                                                                                                                                                                                                                                                          | Block                                                                                       |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       | -  **Verification code**: WAF allows requests that trigger the rule as long as your website visitors complete the required verification.                                                                                                                                                                                                                                                            |                                                                                             |
      |                       | -  **Block**: WAF blocks requests that trigger the rule.                                                                                                                                                                                                                                                                                                                                            |                                                                                             |
      |                       | -  **Block dynamically**: WAF blocks requests that trigger the rule based on **Allowable Frequency**, which you configure after the first rate limit period is over.                                                                                                                                                                                                                                |                                                                                             |
      |                       | -  **Log only**: WAF only logs requests that trigger the rule.                                                                                                                                                                                                                                                                                                                                      |                                                                                             |
      +-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+
      | Application Schedule  | -  **Immediate**: The rule works immediately after it is enabled.                                                                                                                                                                                                                                                                                                                                   | Immediate                                                                                   |
      |                       | -  **Custom**: You can select a time range for the rule to work.                                                                                                                                                                                                                                                                                                                                    |                                                                                             |
      +-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+
      | Allowable Frequency   | This parameter can be set if you select **Block dynamically** for **Protective Action**.                                                                                                                                                                                                                                                                                                            | **8** requests allowed in **60** seconds                                                    |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       | WAF blocks requests that trigger the rule based on **Rate Limit** first. Then, in the following rate limit period, WAF blocks requests that trigger the rule based on **Allowable Frequency** you configure.                                                                                                                                                                                        |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       | **Allowable Frequency** cannot be larger than **Rate Limit**.                                                                                                                                                                                                                                                                                                                                       |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       | .. note::                                                                                                                                                                                                                                                                                                                                                                                           |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       |    If you set **Allowable Frequency** to **0**, WAF blocks all requests that trigger the rule in the next rate limit period.                                                                                                                                                                                                                                                                        |                                                                                             |
      +-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+
      | Block Duration        | Period of time for which to block the item when you set **Protective Action** to **Block**.                                                                                                                                                                                                                                                                                                         | **600** seconds                                                                             |
      +-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+
      | Block Page            | The page displayed if the request limit has been reached. This parameter is configured only when **Protective Action** is set to **Block**.                                                                                                                                                                                                                                                         | Custom                                                                                      |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       | -  If you select **Default settings**, the default block page is displayed.                                                                                                                                                                                                                                                                                                                         |                                                                                             |
      |                       | -  If you select **Custom**, you can write a custom error message, so that WAF will return this message to website visitors when their requests are blocked.                                                                                                                                                                                                                                        |                                                                                             |
      +-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+
      | Block Page Type       | If you select **Custom** for **Block Page**, select a type of the block page among options **application/json**, **text/html**, and **text/xml**.                                                                                                                                                                                                                                                   | text/html                                                                                   |
      +-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+
      | Page Content          | If you select **Custom** for **Block Page**, configure the content to be returned.                                                                                                                                                                                                                                                                                                                  | Page content styles corresponding to different page types are as follows:                   |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                             |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     | -  **text/html**: <html><body>Forbidden</body></html>                                       |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     | -  **application/json**: {"msg": "Forbidden"}                                               |
      |                       |                                                                                                                                                                                                                                                                                                                                                                                                     | -  **text/xml**: <?xml version="1.0" encoding="utf-8"?><error> <msg>Forbidden</msg></error> |
      +-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------+

#. Click **Confirm**. You can then view the added CC attack protection rule in the CC rule list.

   -  To disable a rule, click **Disable** in the **Operation** column of the rule. The default **Rule Status** is **Enabled**.
   -  To modify a rule, click **Modify** in the row containing the rule.
   -  To delete a rule, click **Delete** in the row containing the rule.

Protection Effect
-----------------

If you have configured a CC attack protection rule like :ref:`Figure 1 <waf_01_0009__fig1083929152617>` (with **Protective Action** set to **Block**) for your domain name **www.example.com**, take the following steps to verify the protection effect:

#. Clear the browser cache and enter the domain name in the address bar to check whether the website is accessible.

   -  If the website is inaccessible, connect the website domain name to WAF by referring to :ref:`Step 1: Add Your Website to WAF <waf_01_0326>`.
   -  If the website is accessible, go to :ref:`2 <waf_01_0009__li88102353919>`.

#. .. _waf_01_0009__li88102353919:

   Clear the browser cache, enter **http://www.example.com/admin** in the address bar, and refresh the page 10 times within 60 seconds. In normal cases, the custom block page will be displayed the eleventh time you refresh the page, and the requested page will be accessible when you refresh the page 60 seconds later.

   If you select **Verification code** for protective action, a verification code is required for visitors to continue the access if they exceed the configured rate limit.


   .. figure:: /_static/images/en-us_image_0000002126107914.png
      :alt: **Figure 2** Verification code

      **Figure 2** Verification code

#. Return to the WAF console. In the navigation pane on the left, choose **Events**. On the displayed page, view the event log.

Configuration Example - Verification Code
-----------------------------------------

If domain name **www.example.com** has been connected to WAF, perform the following steps to verify that WAF CAPTCHA verification is enabled.

#. Add a CC attack protection rule with **Protection Action** set to **Verification code**.


   .. figure:: /_static/images/en-us_image_0000002019512640.png
      :alt: **Figure 3** Verification code

      **Figure 3** Verification code

#. Enable CC attack protection.


   .. figure:: /_static/images/en-us_image_0000002090587337.png
      :alt: **Figure 4** Enabling CC Attack Protection

      **Figure 4** Enabling CC Attack Protection

#. Clear the browser cache and access http://www.example.com/admin/.

   If you access the page 10 times within 60 seconds, a verification code is required when you attempt to access the page for the eleventh time. You need to enter the verification code to continue the access.


   .. figure:: /_static/images/en-us_image_0000002126107914.png
      :alt: **Figure 5** Verification code

      **Figure 5** Verification code

#. Go to the WAF console. In the navigation pane on the left, choose **Events**. View the event on the **Events** page.

.. |image1| image:: /_static/images/en-us_image_0000002194533712.jpg
.. |image2| image:: /_static/images/en-us_image_0000002194070596.png
.. |image3| image:: /_static/images/en-us_image_0000002054495070.png
.. |image4| image:: /_static/images/en-us_image_0000001761857181.png
